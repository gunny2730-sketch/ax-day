<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AX-DAY Â· ì²´í—˜ì¡° & ì‹ì‚¬ì¡° (Supabase Realtime)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f3f4f6; font-family: ui-sans-serif, system-ui; }
    .team-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap:16px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-6xl bg-white rounded-3xl shadow-xl border border-gray-200 p-6 md:p-10">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-6">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold">AX-DAY Â· ì²´í—˜ì¡° & ì‹ì‚¬ì¡°</h1>
        <p class="text-gray-500 mt-2">ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ìë™ ë°°ì • Â· ì‹¤ì‹œê°„ ë™ê¸°í™” ë©ë‹ˆë‹¤.</p>
      </div>
      <div class="flex gap-2">
        <button id="exportCsv" class="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-xl hover:bg-gray-300">ê²°ê³¼ CSV</button>
        <button id="resetBtn" class="bg-rose-500 text-white font-semibold px-4 py-2 rounded-xl hover:bg-rose-600">ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3 mb-6 text-sm text-gray-600">
      <div id="uidBox" class="px-3 py-2 bg-gray-50 border border-gray-200 rounded">UID ìƒì„± ì¤‘...</div>
      <button id="copyUrl" class="text-sky-600 hover:text-sky-800">URL ë³µì‚¬</button>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-blue-50 p-4 rounded-xl text-center border border-blue-100">
        <p class="text-sm text-gray-500">ì²´í—˜ì¡° ì •ì›</p>
        <p id="expCount" class="text-2xl font-bold text-blue-600">0/22</p>
      </div>
      <div class="bg-orange-50 p-4 rounded-xl text-center border border-orange-100">
        <p class="text-sm text-gray-500">ì‹ì‚¬ì¡° ì •ì›</p>
        <p id="dinCount" class="text-2xl font-bold text-orange-600">0/22</p>
      </div>
      <div class="bg-sky-50 p-4 rounded-xl text-center border border-sky-100">
        <p class="text-sm text-gray-500">ì´ ì¸ì›</p>
        <p id="totalCount" class="text-2xl font-bold text-sky-600">0ëª…</p>
      </div>
      <div class="bg-gray-50 p-4 rounded-xl text-center border border-gray-100">
        <p class="text-sm text-gray-500">ë‚¨ì€ ì¢Œì„</p>
        <p id="remain" class="text-2xl font-bold">22</p>
      </div>
    </div>

    <div class="mb-8">
      <h3 class="text-lg font-bold text-gray-700 mb-2">ì´ë¦„ ì…ë ¥</h3>
      <div class="flex gap-2">
        <input id="nameInput" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500"
               placeholder="ì˜ˆ) ê¹€ìš°ì§„" />
        <button id="assignBtn" class="bg-sky-600 text-white font-semibold px-6 rounded-lg hover:bg-sky-700">ë°°ì •í•˜ê¸°</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">Â· URLë§Œ ìˆìœ¼ë©´ ëˆ„êµ¬ë‚˜ ì…ë ¥ ê°€ëŠ¥ Â· í•œ ì‚¬ëŒì´ ì—¬ëŸ¬ ë²ˆ ì…ë ¥í•˜ì§€ ì•Šë„ë¡ ì•ˆë‚´ í•„ìš”</p>
    </div>

    <div class="flex flex-col gap-8">
      <div class="p-6 rounded-xl border border-orange-200 bg-orange-100">
        <h2 class="text-xl font-bold text-orange-800 mb-4">ì‹ì‚¬ì¡° ABCD</h2>
        <div id="dinContainer" class="team-grid"></div>
      </div>
      <div class="p-6 rounded-xl border border-blue-200 bg-blue-100">
        <h2 class="text-xl font-bold text-blue-800 mb-4">ì²´í—˜ì¡° 1~6</h2>
        <div id="expContainer" class="team-grid"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import { v4 as uuidv4 } from "https://esm.sh/uuid@9";

    // Supabase ì—°ê²°
    const SUPABASE_URL = "https://ewfbnjmofbvszelndpmm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3ZmJuam1vZmJ2c3plbG5kcG1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MTg5OTIsImV4cCI6MjA3MzQ5NDk5Mn0.wnrK_4sVXlmumfs0IIqShSAk9XkEnslu7upzS91j0TQ";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM
    const uidBox = document.getElementById('uidBox');
    const nameInput = document.getElementById('nameInput');
    const assignBtn = document.getElementById('assignBtn');
    const exportCsv = document.getElementById('exportCsv');
    const resetBtn = document.getElementById('resetBtn');
    const copyUrl = document.getElementById('copyUrl');

    const expCount = document.getElementById('expCount');
    const dinCount = document.getElementById('dinCount');
    const totalCount = document.getElementById('totalCount');
    const remain = document.getElementById('remain');

    const expContainer = document.getElementById('expContainer');
    const dinContainer = document.getElementById('dinContainer');

    // íŒ€ ì •ì˜
    const totalMax = 22;
    const expTeamNames = ['íŒ€ 1','íŒ€ 2','íŒ€ 3','íŒ€ 4','íŒ€ 5','íŒ€ 6'];
    const expSizes     = [4,4,4,4,3,3];
    const dinTeamNames = ['íŒ€ A','íŒ€ B','íŒ€ C','íŒ€ D'];
    const dinSizes     = [6,6,6,4];

    // ëœë¤ UID
    let user = { id: uuidv4() };
    uidBox.textContent = `í˜„ì¬ ì‚¬ìš©ì ID: ${user.id}`;

    let all = [];

    // ì´ˆê¸° ë¡œë“œ
    await loadMembers();
    subscribeRealtime();

    async function loadMembers() {
      const { data, error } = await supabase
        .from('members')
        .select('*')
        .order('created_at', { ascending: true });
      if (!error) {
        all = data || [];
        renderAll();
      } else {
        console.error(error);
      }
    }

    function subscribeRealtime() {
      supabase.channel('members-realtime')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'members' }, async () => {
          await loadMembers();
        })
        .subscribe();
    }

    function renderCards(container, names, sizes, grouped) {
      container.innerHTML = '';
      names.forEach((nm, i) => {
        const members = grouped[i] || [];
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="font-bold">${nm}</div>
            <div class="text-xs text-gray-500">${members.length}/${sizes[i]}</div>
          </div>
          <ul class="space-y-1">${members.map(m=>`<li class="text-sm text-gray-700 break-words">${m.name}</li>`).join('')}</ul>
        `;
        container.appendChild(card);
      });
    }

    function renderAll() {
      const assigned = all.filter(m => m.assigned);
      totalCount.textContent = `${all.length}ëª…`;
      remain.textContent = Math.max(0, totalMax - all.length);
      expCount.textContent = `${all.length}/22`;
      dinCount.textContent = `${all.length}/22`;

      const expGroup = expTeamNames.map(()=>[]);
      const dinGroup = dinTeamNames.map(()=>[]);
      for (const m of assigned) {
        const ei = expTeamNames.indexOf(m.experience_team);
        if (ei >= 0) expGroup[ei].push(m);
        const di = dinTeamNames.indexOf(m.dining_team);
        if (di >= 0) dinGroup[di].push(m);
      }
      renderCards(expContainer, expTeamNames, expSizes, expGroup);
      renderCards(dinContainer, dinTeamNames, dinSizes, dinGroup);

      const mine = all.find(m => m.user_id === user.id);
      const disabled = !!mine;
      nameInput.disabled = disabled;
      assignBtn.disabled = disabled;
      nameInput.placeholder = disabled ? 'ì´ë¯¸ ì´ë¦„ì„ ì…ë ¥í•˜ì…¨ìŠµë‹ˆë‹¤.' : 'ì˜ˆ) ê¹€ìš°ì§„';
    }

    function pickExperienceTeam() {
      const counts = expTeamNames.map((_, i) => all.filter(m => m.assigned && m.experience_team === expTeamNames[i]).length);
      const avail = expTeamNames.map((nm, i) => ({ i, left: expSizes[i] - counts[i] }))
        .filter(x => x.left > 0);
      if (avail.length === 0) return '';
      const maxLeft = Math.max(...avail.map(x => x.left));
      const candidates = avail.filter(x => x.left === maxLeft);
      const chosen = candidates[Math.floor(Math.random()*candidates.length)];
      return expTeamNames[chosen.i];
    }

    function pickDiningTeam(assignedExpTeam) {
      const dinCounts = dinTeamNames.map((_, i) => all.filter(m => m.assigned && m.dining_team === dinTeamNames[i]).length);
      const avail = dinTeamNames.map((nm, i) => ({ i, left: dinSizes[i] - dinCounts[i] }))
        .filter(x => x.left > 0);
      if (avail.length === 0) return '';
      const scored = avail.map(a => {
        const inThisTeam = all.filter(m => m.assigned && m.dining_team === dinTeamNames[a.i]);
        const overlap = inThisTeam.filter(m => m.experience_team === assignedExpTeam).length;
        return { i: a.i, overlap, left: a.left };
      });
      scored.sort((a,b) => (a.overlap - b.overlap) || (b.left - a.left));
      return dinTeamNames[scored[0].i];
    }

    async function addName() {
      const name = nameInput.value.trim();
      if (!name) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      if (all.length >= totalMax) return alert('ëª¨ë“  ì¢Œì„ì´ ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤.');
      if (all.some(m => m.name === name)) return alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.');

      const expTeam = pickExperienceTeam();
      const dinTeam = pickDiningTeam(expTeam);

      const { error } = await supabase.from('members').insert({
        name,
        user_id: user.id,
        assigned: true,              // â† ë°”ë¡œ ë°°ì •
        experience_team: expTeam,
        dining_team: dinTeam
      });

      if (error) { 
        if (error.message?.includes('duplicate key value')) {
          alert('ì´ë¯¸ ë“±ë¡ëœ ì´ë¦„ì…ë‹ˆë‹¤.');
        } else {
          alert(error.message || 'ì¶”ê°€ ì‹¤íŒ¨');
        }
        return;
      }

      nameInput.value = '';
      await loadMembers(); // â† ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨(Realtime ëª» ë°›ì•„ë„ ë³´ì¥)
    }

    assignBtn.addEventListener('click', addName);
    nameInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') addName(); });

    exportCsv.addEventListener('click', () => {
      const rows = [];
      const expMap = expTeamNames.map(nm => all.filter(m => m.assigned && m.experience_team === nm).map(m=>m.name));
      const dinMap = dinTeamNames.map(nm => all.filter(m => m.assigned && m.dining_team === nm).map(m=>m.name));
      rows.push('ì‹ì‚¬ì¡°');
      dinTeamNames.forEach((nm, i) => rows.push([nm].concat(dinMap[i]).join(',')));
      rows.push('');
      rows.push('ì²´í—˜ì¡°');
      expTeamNames.forEach((nm, i) => rows.push([nm].concat(expMap[i]).join(',')));
      const csv = "\uFEFF" + rows.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ì¡°í¸ì„±_ê²°ê³¼.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    resetBtn.addEventListener('click', async () => {
      const code = prompt('ê´€ë¦¬ì ì½”ë“œ ì…ë ¥:');
      if (!code) return;

      resetBtn.disabled = true;
      const originalText = resetBtn.textContent;
      resetBtn.textContent = 'ì´ˆê¸°í™” ì¤‘...';

      try {
        const { data, error } = await supabase.rpc('reset_all_with_code', { p_code: code });
        if (error) return alert(error.message || 'ì´ˆê¸°í™” ì‹¤íŒ¨');

        if (data === 'ok') {
          alert('ì´ˆê¸°í™” ì™„ë£Œ');
          await loadMembers();  // ğŸ‘ˆ ì´ˆê¸°í™” ì§í›„ ì¦‰ì‹œ ë°˜ì˜
        } else if (data === 'unauthorized') {
          alert('ê´€ë¦¬ì ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        } else if (data === 'no_admin_code_set') {
          alert('ê´€ë¦¬ì ì½”ë“œê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.(DB app_metadata í™•ì¸)');
        } else {
          alert('ì•Œ ìˆ˜ ì—†ëŠ” ì‘ë‹µ: ' + data);
        }
      } finally {
        resetBtn.disabled = false;
        resetBtn.textContent = originalText;
      }
    });

    copyUrl.addEventListener('click', () => {
      navigator.clipboard.writeText(location.href).then(
        ()=>alert('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'),
        ()=>alert('ë³µì‚¬ ì‹¤íŒ¨: ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.')
      );
    });
  </script>
</body>
</html>
