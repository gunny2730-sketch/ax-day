<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AX-DAY · 체험조 & 식사조 (Supabase Realtime)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f3f4f6; font-family: ui-sans-serif, system-ui; }
    .team-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap:16px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-6xl bg-white rounded-3xl shadow-xl border border-gray-200 p-6 md:p-10">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-6">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold">AX-DAY · 체험조 & 식사조</h1>
        <p class="text-gray-500 mt-2">이름을 입력하면 자동 배정 · 실시간 동기화 됩니다.</p>
      </div>
      <div class="flex gap-2">
        <button id="exportCsv" class="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-xl hover:bg-gray-300">결과 CSV</button>
        <button id="resetBtn" class="bg-rose-500 text-white font-semibold px-4 py-2 rounded-xl hover:bg-rose-600">초기화</button>
      </div>
    </div>

    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3 mb-6 text-sm text-gray-600">
      <div id="uidBox" class="px-3 py-2 bg-gray-50 border border-gray-200 rounded">UID 생성 중...</div>
      <button id="copyUrl" class="text-sky-600 hover:text-sky-800">URL 복사</button>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-blue-50 p-4 rounded-xl text-center border border-blue-100">
        <p class="text-sm text-gray-500">체험조 정원</p>
        <p id="expCount" class="text-2xl font-bold text-blue-600">—</p>
      </div>
      <div class="bg-orange-50 p-4 rounded-xl text-center border border-orange-100">
        <p class="text-sm text-gray-500">식사조 정원</p>
        <p id="dinCount" class="text-2xl font-bold text-orange-600">—</p>
      </div>
      <div class="bg-sky-50 p-4 rounded-xl text-center border border-sky-100">
        <p class="text-sm text-gray-500">총 인원</p>
        <p id="totalCount" class="text-2xl font-bold text-sky-600">—</p>
      </div>
      <div class="bg-gray-50 p-4 rounded-xl text-center border border-gray-100">
        <p class="text-sm text-gray-500">남은 좌석</p>
        <p id="remain" class="text-2xl font-bold">—</p>
      </div>
    </div>

    <div class="mb-8">
      <h3 class="text-lg font-bold text-gray-700 mb-2">이름 입력</h3>
      <div class="flex gap-2">
        <input id="nameInput" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500"
               placeholder="예) 김우진" />
        <button id="assignBtn" class="bg-sky-600 text-white font-semibold px-6 rounded-lg hover:bg-sky-700">배정하기</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">· 기도하면서 이름을 입력해 주세요.</p>
    </div>

    <div class="flex flex-col gap-8">
      <div class="p-6 rounded-xl border border-orange-200 bg-orange-100">
        <h2 class="text-xl font-bold text-orange-800 mb-4">식사조 ABCD</h2>
        <div id="dinContainer" class="team-grid"></div>
      </div>
      <div class="p-6 rounded-xl border border-blue-200 bg-blue-100">
        <h2 class="text-xl font-bold text-blue-800 mb-4">체험조 1~6</h2>
        <div id="expContainer" class="team-grid"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import { v4 as uuidv4 } from "https://esm.sh/uuid@9";

    // Supabase 연결
    const SUPABASE_URL = "https://ewfbnjmofbvszelndpmm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3ZmJuam1vZmJ2c3plbG5kcG1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MTg5OTIsImV4cCI6MjA3MzQ5NDk5Mn0.wnrK_4sVXlmumfs0IIqShSAk9XkEnslu7upzS91j0TQ";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === LocalStorage 기반 UID 저장 ===
    let savedUid = localStorage.getItem("axday_uid");
    if (!savedUid) {
      savedUid = uuidv4();
      localStorage.setItem("axday_uid", savedUid);
    }
    let user = { id: savedUid };
    uidBox.textContent = `현재 사용자 ID: ${user.id}`;

    // DOM
    const nameInput = document.getElementById('nameInput');
    const assignBtn = document.getElementById('assignBtn');
    const exportCsv = document.getElementById('exportCsv');
    const resetBtn = document.getElementById('resetBtn');
    const copyUrl = document.getElementById('copyUrl');

    const expCount = document.getElementById('expCount');
    const dinCount = document.getElementById('dinCount');
    const totalCount = document.getElementById('totalCount');
    const remain = document.getElementById('remain');

    const expContainer = document.getElementById('expContainer');
    const dinContainer = document.getElementById('dinContainer');

    // ===== 팀 정의 (최신 요청 반영) =====
    // 식사조: 6,6,5,4  → 합계 21
    const dinTeamNames = ['팀 A','팀 B','팀 C','팀 D'];
    const dinSizes     = [6,6,5,4];

    // 체험조: 4,4,3,4,3,3 (“443433”) → 합계 21
    const expTeamNames = ['팀 1','팀 2','팀 3','팀 4','팀 5','팀 6'];
    const expSizes     = [4,4,3,4,3,3];

    // 영역별 정원 합계와 총 정원(두 영역 중 더 작은 값 사용)
    const EXP_CAP   = expSizes.reduce((a,b)=>a+b,0); // 21
    const DIN_CAP   = dinSizes.reduce((a,b)=>a+b,0); // 21
    const TOTAL_CAP = Math.min(EXP_CAP, DIN_CAP);    // 21

    let all = [];

    // 초기 로드
    await loadMembers();
    subscribeRealtime();

    async function loadMembers() {
      const { data, error } = await supabase
        .from('members')
        .select('*')
        .order('created_at', { ascending: true });
      if (!error) {
        all = data || [];
        renderAll();
      }
    }

    function subscribeRealtime() {
      supabase.channel('members-realtime')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'members' }, async () => {
          await loadMembers();
        })
        .subscribe();
    }

    function renderCards(container, names, sizes, grouped) {
      container.innerHTML = '';
      names.forEach((nm, i) => {
        const members = grouped[i] || [];
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="font-bold">${nm}</div>
            <div class="text-xs text-gray-500">${members.length}/${sizes[i]}</div>
          </div>
          <ul class="space-y-1">${members.map(m=>`<li class="text-sm text-gray-700 break-words">${m.name}</li>`).join('')}</ul>
        `;
        container.appendChild(card);
      });
    }

    function renderAll() {
      const assigned = all.filter(m => m.assigned);
      const assignedCount = assigned.length;

      totalCount.textContent = `${assignedCount}명`;
      remain.textContent = Math.max(0, TOTAL_CAP - assignedCount);

      // 상단 요약: 현재 참여 인원 / 각 영역 정원
      expCount.textContent = `${Math.min(assignedCount, EXP_CAP)}/${EXP_CAP}`;
      dinCount.textContent = `${Math.min(assignedCount, DIN_CAP)}/${DIN_CAP}`;

      const expGroup = expTeamNames.map(()=>[]);
      const dinGroup = dinTeamNames.map(()=>[]);

      for (const m of assigned) {
        const ei = expTeamNames.indexOf(m.experience_team);
        if (ei >= 0) expGroup[ei].push(m);
        const di = dinTeamNames.indexOf(m.dining_team);
        if (di >= 0) dinGroup[di].push(m);
      }
      renderCards(expContainer, expTeamNames, expSizes, expGroup);
      renderCards(dinContainer, dinTeamNames, dinSizes, dinGroup);

      // 입력 제한
      const mine = all.find(m => m.user_id === user.id);
      const isFull = assignedCount >= TOTAL_CAP;
      const disabled = !!mine || isFull;

      nameInput.disabled = disabled;
      assignBtn.disabled = disabled;
      nameInput.placeholder = mine
        ? '이미 이름을 입력하셨습니다.'
        : (isFull ? '정원이 마감되었습니다.' : '예) 김우진');
    }

    function pickExperienceTeam() {
      // 남은 자리가 있는 팀 중: 남은 자리 최다 → 무작위
      const counts = expTeamNames.map((_, i) =>
        all.filter(m => m.assigned && m.experience_team === expTeamNames[i]).length
      );
      const avail = expTeamNames.map((nm, i) => ({ i, left: expSizes[i] - counts[i] }))
        .filter(x => x.left > 0); // 이미 넘친 팀은 제외
      if (avail.length === 0) return '';
      const maxLeft = Math.max(...avail.map(x => x.left));
      const candidates = avail.filter(x => x.left === maxLeft);
      const chosen = candidates[Math.floor(Math.random()*candidates.length)];
      return expTeamNames[chosen.i];
    }

    function pickDiningTeam(assignedExpTeam) {
      // 같은 체험팀과의 겹침 최소화 → 동률이면 남은 자리 많은 팀
      const dinCounts = dinTeamNames.map((_, i) =>
        all.filter(m => m.assigned && m.dining_team === dinTeamNames[i]).length
      );
      const avail = dinTeamNames.map((nm, i) => ({ i, left: dinSizes[i] - dinCounts[i] }))
        .filter(x => x.left > 0);
      if (avail.length === 0) return '';
      const scored = avail.map(a => {
        const inThisTeam = all.filter(m => m.assigned && m.dining_team === dinTeamNames[a.i]);
        const overlap = inThisTeam.filter(m => m.experience_team === assignedExpTeam).length;
        return { i: a.i, overlap, left: a.left };
      });
      scored.sort((a,b) => (a.overlap - b.overlap) || (b.left - a.left));
      return dinTeamNames[scored[0].i];
    }

    async function addName() {
      const name = nameInput.value.trim();
      if (!name) return alert('이름을 입력해주세요.');

      const assignedCount = all.filter(m => m.assigned).length;
      if (assignedCount >= TOTAL_CAP) return alert('모든 좌석이 채워졌습니다.');
      if (all.some(m => m.name === name)) return alert('이미 존재하는 이름입니다.');

      const expTeam = pickExperienceTeam();
      if (!expTeam) return alert('체험조 정원이 가득 찼습니다.');

      const dinTeam = pickDiningTeam(expTeam);
      if (!dinTeam) return alert('식사조 정원이 가득 찼습니다.');

      const { error } = await supabase.from('members').insert({
        name,
        user_id: user.id,
        assigned: true,
        experience_team: expTeam,
        dining_team: dinTeam
      });

      if (error) {
        if (error.message?.includes('duplicate key value')) {
          alert('이미 등록된 이름입니다.');
        } else {
          alert(error.message || '추가 실패');
        }
        return;
      }

      nameInput.value = '';
      await loadMembers();
    }

    exportCsv.addEventListener('click', () => {
      const rows = [];
      const expMap = expTeamNames.map(nm => all.filter(m => m.assigned && m.experience_team === nm).map(m=>m.name));
      const dinMap = dinTeamNames.map(nm => all.filter(m => m.assigned && m.dining_team === nm).map(m=>m.name));
      rows.push('식사조');
      dinTeamNames.forEach((nm, i) => rows.push([nm].concat(dinMap[i]).join(',')));
      rows.push('');
      rows.push('체험조');
      expTeamNames.forEach((nm, i) => rows.push([nm].concat(expMap[i]).join(',')));
      const csv = "\uFEFF" + rows.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = '조편성_결과.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    resetBtn.addEventListener('click', async () => {
      const code = prompt('관리자 코드 입력:');
      if (!code) return;

      resetBtn.disabled = true;
      const originalText = resetBtn.textContent;
      resetBtn.textContent = '초기화 중...';

      try {
        const { data, error } = await supabase.rpc('reset_all_with_code', { p_code: code });
        if (error) return alert(error.message || '초기화 실패');

        if (data === 'ok') {
          alert('초기화 완료');
          await loadMembers();
        } else if (data === 'unauthorized') {
          alert('관리자 코드가 올바르지 않습니다.');
        } else if (data === 'no_admin_code_set') {
          alert('관리자 코드가 아직 설정되지 않았습니다.(DB app_metadata 확인)');
        } else {
          alert('알 수 없는 응답: ' + data);
        }
      } finally {
        resetBtn.disabled = false;
        resetBtn.textContent = originalText;
      }
    });

    copyUrl.addEventListener('click', () => {
      navigator.clipboard.writeText(location.href).then(
        ()=>alert('URL이 복사되었습니다.'),
        ()=>alert('복사 실패: 직접 복사해주세요.')
      );
    });
  </script>
</body>
</html>
